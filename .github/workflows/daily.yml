name: Stock News Bot

on:
  # schedule:
  #   - cron: '30 0 * * 1-5'  <-- å·²æ³¨é‡Šï¼Œäº¤ç”± Google Scheduler è§¦å‘
  workflow_dispatch:

permissions:
  contents: write  # âš ï¸ å¿…é¡»å¼€å¯å†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³•ä¿å­˜é€‰è‚¡ç»“æžœ

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          
      - name: Install Dependencies
        run: pip install requests openai
        
      # 1. è¿è¡Œæ—©æŠ¥ (ä¸å½±å“é€‰è‚¡)
      - name: Run Daily News
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: python main.py daily

      # 2. è¿è¡Œ AI é€‰è‚¡ (Recommend Mode)
      # è¿™ä¸€æ­¥çŽ°åœ¨ä¼šåŒæ—¶ç”Ÿæˆ stock_pick.json å’Œ history.csv
      - name: Run AI Recommendation
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: python main.py recommend

      # 3. ðŸ’¾ å°†é€‰è‚¡è®°å¿†æ–‡ä»¶ å’Œ åŽ†å²æˆ˜ç»©è¡¨ æäº¤å›žä»“åº“
      - name: Commit & Push Memory
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # å…ˆæ‹‰å–æœ€æ–°ä»£ç ï¼Œé˜²æ­¢å¤šäººæ“ä½œå¯¼è‡´å†²çª
          git pull --rebase || echo "No remote changes"

          # å¼ºåˆ¶æ·»åŠ è¿™ä¸¤ä¸ªæ–‡ä»¶ (å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™)
          git add stock_pick.json history.csv || true
          
          # æäº¤å¹¶æŽ¨é€
          git commit -m "Update Daily Stock Pick & History [skip ci]" || echo "No changes to commit"
          git push
